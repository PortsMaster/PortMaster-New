#!/bin/bash
# Set GAMEDIR to the current directory and set logfile
GAMEDIR="$PWD"
LOGFILE="$GAMEDIR/patchlog.txt"
LOGERR="$GAMEDIR/patchlog_error.txt"
START_TIME=$(date +%s)

# Redirect output and error to the log file
exec > >(tee -a "$LOGFILE") 2>&1
echo "GAMEDIR is set to: $GAMEDIR"

# Patch failure function
patch_failure() {
    mv "$LOGFILE" "$LOGERR"
    echo "Patching process failed."
    exit 1
}

# Exports
export PATH="$controlfolder:$DOTNETDIR:$TOOLKIT/gmtools:$TOOLKIT/utmt-cli:$PATH"
export LD_LIBRARY_PATH="/usr/lib:$TOOLKIT/libs:$LD_LIBRARY_PATH"
export SDL_GAMECONTROLLERCONFIG="$sdl_controllerconfig"
export DATADIR="$GAMEDIR/assets"
export DEMOFILE="operiusdxdemo.port"
export DATAFILE="operiusdx.port"
export TMPDIR="$GAMEDIR/tmp"

# Permissions
chmod 666 /dev/uinput

# Set up trap for cleaning TMPDIR on exit
trap 'rm -rf "$TMPDIR"; echo "Cleaned up temporary files." >> "$LOGFILE"' 0

# Attempt to get SAVEDIR from gmloader.json using jq
if command -v jq >/dev/null 2>&1; then
    SAVEDIR=$(jq -r '.save_dir // empty' "$GAMEDIR/gmloader.json" 2>/dev/null)
else
    SAVEDIR="$GAMEDIR/saves"
fi

# Test for commands: python, zip
PYTHON=$(which python3)
if [ -z "$PYTHON" ]; then
    echo "Missing Python!"
    patch_failure
fi

ZIP=$(which zip)
if [ -z "$ZIP" ]; then
    echo "Missing zip!"
    patch_failure
fi

prepare_files() {
    echo "Preparing files..."

    # Create necessary directories
    mkdir -p "$SAVEDIR" "$DATADIR"

    # Remove unwanted leftover files
    rm -rf "$DATADIR"/*.ini "$DATADIR"/*.gitkeep
    echo "Removed unnecessary files..."

    # Clean and recreate temporary directory
    rm -rf "$TMPDIR"
    mkdir -p "$TMPDIR"

    # Extract the demo file - allow it to continue even with some file conflicts
    echo "Extracting $DEMOFILE..."
    unzip -o -q "$DEMOFILE" -d "$TMPDIR" || {
        # Check if critical files were extracted despite errors
        if [ ! -d "$TMPDIR/res" ] && [ ! -d "$TMPDIR/assets" ]; then
            echo "[prepare_files]: Failed to unzip $DEMOFILE - no content extracted"
            exit 1
        fi
        echo "Warning: Some files had conflicts but extraction continued"
    }

    # Move extracted contents into $DATADIR
    mv "$TMPDIR"/* "$DATADIR"/

    # Delete demo-specific or unneeded files before patching
    rm -f "$DEMOFILE"
    rm -f "$DATADIR"/assets/game.droid
    rm -f "$DATADIR"/lib/arm64-v8a/libyoyo.so
    rm -rf "$DATADIR"/lib/x86_64
    rm -rf "$DATADIR"/lib/armeabi-v7a
	
    # Cleanup temp directory
    rm -rf "$TMPDIR"

    echo "Preparation complete: Demo extracted, cleaned, and ready for patching."
}

apply_patch() {
    # Check if the data.win file exists and apply xdelta
    if [ -f "$DATADIR/data.win" ]; then
        echo "Applying xdelta patch"
		output=$(xdelta3 -d -s "$DATADIR/data.win" -f "./tools/data.patch" "$DATADIR/game.droid" 2>&1)
        if [ $? -eq 0 ]; then
            echo "Patch applied successfully"
            echo "$output"
            rm "$DATADIR/data.win"
        else
            echo "Failed to apply patch"
            echo "$output"
            exit 1
        fi
    else
        echo "No data.win file found to patch!"
    fi
	
	# Check if the Operius DX.exe file exists and apply xdelta
    if [ -f "$DATADIR/Operius DX.exe" ]; then
        echo "Applying xdelta patch"
		output=$(xdelta3 -d -s "$DATADIR/Operius DX.exe" -f "./tools/game.patch" "$DATADIR/libyoyo.so" 2>&1)
        if [ $? -eq 0 ]; then
            echo "Patch applied successfully"
            echo "$output"
            rm "$DATADIR/Operius DX.exe"
        else
            echo "Failed to apply patch"
            echo "$output"
            exit 1
        fi
    else
        echo "No Operius DX.exe file found to patch!"
    fi
	sleep 1
}

repack_datafile() {
    echo "Repacking patched files into new data file..."
    
    # Validate required variables
    for var in DATADIR TMPDIR GAMEDIR; do
        if [ -z "${!var}" ]; then
            echo "[repack_datafile]: Error - \$$var not set!"
            return 1
        fi
    done
    
    # Ensure $DATADIR exists
    if [ ! -d "$DATADIR" ]; then
        echo "[repack_datafile]: Error - $DATADIR not found!"
        return 1
    fi
    
    # Ensure there's something to package
    if [ ! -f "$DATADIR/game.droid" ] && [ ! -f "$DATADIR/libyoyo.so" ]; then
        echo "[repack_datafile]: No patched files found to package!"
        return 1
    fi
    
    # Clean and prepare $TMPDIR
    rm -rf "$TMPDIR"
    mkdir -p "$TMPDIR/assets" "$TMPDIR/lib/arm64-v8a" || {
        echo "[repack_datafile]: Failed to create temp directories!"
        return 1
    }
    
    # Move patched files into correct structure
    [ -f "$DATADIR/game.droid" ] && mv -f "$DATADIR/game.droid" "$TMPDIR/assets/game.droid"
    [ -f "$DATADIR/libyoyo.so" ] && mv -f "$DATADIR/libyoyo.so" "$TMPDIR/lib/arm64-v8a/libyoyo.so"
    
    # Copy remaining contents (everything except the moved files)
    for item in "$DATADIR"/*; do
        [ -e "$item" ] || continue
        basename="${item##*/}"
        [ "$basename" = "game.droid" ] || [ "$basename" = "libyoyo.so" ] && continue
        cp -r "$item" "$TMPDIR/" || {
            echo "[repack_datafile]: Failed to copy $basename!"
            return 1
        }
    done
    
    # Build operiusdx.port (ZIP with no compression) in subshell
    (
        cd "$TMPDIR" || exit 1
        zip -r -0 -q "operiusdx.port" . || exit 1
    ) || {
        echo "[repack_datafile]: Failed to create operiusdx.port!"
        return 1
    }
    
    # Move new data file to $GAMEDIR
    mv "$TMPDIR/operiusdx.port" "$GAMEDIR/" || {
        echo "[repack_datafile]: Failed to move archive to $GAMEDIR!"
        return 1
    }

    # Clean up assets directory
    rm -rf "$DATADIR"
    echo "Cleaned up $DATADIR"
	
    # Update gmloader.json
    if [ -f "$GAMEDIR/gmloader.json" ]; then
        sed -i 's/"apk_path" *: *"operiusdxdemo\.port"/"apk_path" : "operiusdx.port"/' "$GAMEDIR/gmloader.json"
        echo "Updated gmloader.json â†’ apk_path now points to operiusdx.port"
    fi
    
    echo "New data file created successfully: $GAMEDIR/operiusdx.port"
}

# Create install completion flag
install_complete() {
	touch "install_completed"
    # Measure time to complete
	END_TIME=$(date +%s)
    DURATION=$((END_TIME - START_TIME))
    echo "Script completed in $DURATION seconds"
	echo "Installation completed successfully!"
	echo "-----------------------------"
	echo "Process finished at: $(date)"
}

process_game() { 
    echo "Preparing game..."
    prepare_files || patch_failure
	sleep 1
	echo "Patching game..."
	apply_patch || patch_failure
	sleep 1
	echo "Packing the game..."
	repack_datafile || patch_failure
    sleep 1
	echo "Finishing up..."
	install_complete
	sleep 1
	
    # Final completion message
    echo "Patching process complete!"
}

# Call the function
process_game